<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Connection Test</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #1a1a1a; color: #e0e0e0; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        #status-box { background-color: #333; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); text-align: center; }
        h1 { margin-top: 0; }
        p { margin-bottom: 0; }
        .success { color: #4caf50; }
        .error { color: #f44336; }
    </style>
</head>
<body>

    <div id="status-box">
        <h1>Firebase Connection Test</h1>
        <p id="status">Attempting to connect...</p>
    </div>

    <script type="module">
        // Import necessary Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your project's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCKcC_TPxyP9-ErqUTZHWc4Il8llwpwUg8",
            authDomain: "forge23-04-2019.firebaseapp.com",
            projectId: "forge23-04-2019",
            storageBucket: "forge23-04-2019.appspot.com",
            messagingSenderId: "725283917440",
            appId: "1:725283917440:web:3627779e1de23153af2065"
        };

        // Get the status element to show messages on the page
        const statusEl = document.getElementById('status');

        async function runTest() {
            try {
                // 1. Initialize Firebase
                statusEl.textContent = "Initializing Firebase...";
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                statusEl.textContent = "Firebase Initialized Successfully.";

                // 2. Sign in Anonymously
                statusEl.textContent = "Signing in anonymously...";
                const userCredential = await signInAnonymously(auth);
                const user = userCredential.user;
                statusEl.textContent = `Signed in with UID: ${user.uid}`;

                // 3. Write a document to Firestore in a location PERMITTED by the security rules
                statusEl.textContent = "Attempting to write to Firestore...";
                
                // This is the corrected path that matches your security rules
                const testDocRef = doc(db, "users", user.uid, "test_data", "test_doc");
                
                await setDoc(testDocRef, {
                    status: "success",
                    timestamp: serverTimestamp(),
                    message: "This document was written by the corrected test script."
                });
                
                statusEl.innerHTML = '<strong class="success">SUCCESS!</strong><br>Connection successful and data written to Firestore.';

            } catch (error) {
                console.error("Firebase Test Failed:", error);
                statusEl.innerHTML = `<strong class="error">TEST FAILED</strong><br>Error: ${error.message}`;
            }
        }

        // Run the test when the script loads
        runTest();
    </script>
</body>
</html>
