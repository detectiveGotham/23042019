<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productivity Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom Styles & Themes */
        :root {
            --font-main: 'Inter', sans-serif;
            --font-mono: 'Roboto Mono', monospace;
        }

        body {
            font-family: var(--font-main);
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-mono);
        }
        
        /* Default Theme */
        .theme-default {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --accent-color: #0d6efd;
            --accent-color-dark: #0a58ca;
            --flag-color: #fff3cd;
            --flag-border: #ffe69c;
            --progress-bg: #e9ecef;
            --progress-bar: #0d6efd;
            --quit-bg: #dc3545;
            --quit-hover: #c82333;
        }

        /* Matrix Theme */
        .theme-matrix {
            --bg-primary: #0D0208;
            --bg-secondary: #000000;
            --text-primary: #00FF41;
            --text-secondary: #00B32D;
            --border-color: #00FF41;
            --accent-color: #00FF41;
            --accent-color-dark: #00B32D;
            --flag-color: #1a3a1f;
            --flag-border: #00FF41;
            --progress-bg: #00330D;
            --progress-bar: #00FF41;
            --quit-bg: #990000;
            --quit-hover: #660000;
        }

        /* Ignite Theme */
        .theme-ignite {
            --bg-primary: #1a1a1d;
            --bg-secondary: #252528;
            --text-primary: #f5f5f5;
            --text-secondary: #c3073f;
            --border-color: #4e4e50;
            --accent-color: #e84545;
            --accent-color-dark: #d03838;
            --flag-color: #4d2f3a;
            --flag-border: #c3073f;
            --progress-bg: #4e4e50;
            --progress-bar: #e84545;
            --quit-bg: #6f2232;
            --quit-hover: #950740;
        }

        /* Breeze Theme */
        .theme-breeze {
            --bg-primary: #e0f7fa;
            --bg-secondary: #ffffff;
            --text-primary: #004d40;
            --text-secondary: #00796b;
            --border-color: #b2dfdb;
            --accent-color: #009688;
            --accent-color-dark: #00796b;
            --flag-color: #e0f2f1;
            --flag-border: #80cbc4;
            --progress-bg: #b2dfdb;
            --progress-bar: #009688;
            --quit-bg: #d32f2f;
            --quit-hover: #c62828;
        }
        
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .task-item {
            border-left: 2px solid var(--border-color);
            transition: border-color 0.3s;
        }

        .task-item.level-0 { border-left: none; }
        .task-item.level-1 { margin-left: 1rem; }
        .task-item.level-2 { margin-left: 2.5rem; }
        .task-item.level-3 { margin-left: 4rem; }

        .task-item.flagged {
            background-color: var(--flag-color);
            border-left-color: var(--flag-border);
        }

        .progress-container { background-color: var(--progress-bg); }
        .progress-bar { background-color: var(--progress-bar); }
        .header, .modal-content { background-color: var(--bg-secondary); border-bottom: 1px solid var(--border-color); }
        .btn-primary { background-color: var(--accent-color); color: white; }
        .btn-primary:hover { background-color: var(--accent-color-dark); }
        .btn-quit { background-color: var(--quit-bg); color: white; }
        .btn-quit:hover { background-color: var(--quit-hover); }

        .task-controls .control-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .task-item:hover .task-controls .control-btn {
            opacity: 1;
        }
        .task-name {
            cursor: pointer;
        }
        .task-name:hover {
            text-decoration: underline;
        }
        
        .modal {
            background-color: rgba(0,0,0,0.5);
        }

        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="theme-default">

    <div id="app-loader" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
        <div class="text-white text-center">
            <i class="fas fa-spinner fa-spin fa-3x"></i>
            <p class="mt-4 text-xl">Initializing Productivity Hub...</p>
        </div>
    </div>
    
    <div id="access-denied" class="hidden fixed inset-0 bg-gray-900 flex items-center justify-center z-40">
        <div class="text-center text-white p-8 bg-red-800 rounded-lg shadow-2xl">
            <h2 class="text-4xl font-bold mb-4">ACCESS DENIED</h2>
            <p class="text-lg mb-6">You must be logged in to access the Productivity Hub.</p>
            <a href="index.html" class="px-6 py-2 bg-white text-red-800 font-bold rounded hover:bg-gray-200 transition-colors">Go to Login Page</a>
        </div>
    </div>

    <main id="app" class="hidden">
        <!-- Header -->
        <header class="header sticky top-0 z-30 px-4 py-2 flex items-center justify-between shadow-md">
            <h1 id="header-title" class="text-xl font-bold tracking-widest">PRODUCTIVITY HUB 01</h1>
            <div class="flex items-center space-x-4">
                <div class="theme-selector flex items-center space-x-2">
                    <button data-theme="theme-default" class="theme-btn w-6 h-6 rounded-full bg-blue-500 border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"></button>
                    <button data-theme="theme-matrix" class="theme-btn w-6 h-6 rounded-full bg-green-500 border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"></button>
                    <button data-theme="theme-ignite" class="theme-btn w-6 h-6 rounded-full bg-red-600 border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-600"></button>
                    <button data-theme="theme-breeze" class="theme-btn w-6 h-6 rounded-full bg-teal-400 border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-400"></button>
                </div>
                <button id="bulk-add-btn" class="btn-primary px-4 py-2 rounded-md font-semibold">FORGE</button>
                <div class="flex items-center space-x-2">
                    <span id="sync-status" class="text-sm text-gray-500">Synced</span>
                    <i id="sync-icon" class="fas fa-check-circle text-green-500"></i>
                </div>
                <button id="quit-btn" class="btn-quit px-4 py-2 rounded-md font-semibold">QUIT</button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="container mx-auto p-4 lg:p-6">
            <!-- Master Progress & Controls -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <h2 class="text-lg font-bold mb-2">Master Progress</h2>
                <div class="progress-container w-full bg-gray-200 rounded-full h-4">
                    <div id="master-progress-bar" class="progress-bar h-4 rounded-full" style="width: 0%;"></div>
                </div>
                <div class="flex items-center space-x-4 mt-4">
                    <input type="search" id="search-bar" placeholder="Search tasks..." class="flex-grow p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="add-subject-btn" class="btn-primary px-4 py-2 rounded-md font-semibold whitespace-nowrap">Add Subject</button>
                </div>
            </div>

            <!-- Task List -->
            <div id="task-list" class="space-y-2">
                <!-- Tasks will be dynamically inserted here -->
            </div>
        </div>
    </main>

    <!-- Bulk Add Modal -->
    <div id="bulk-add-modal" class="modal hidden fixed inset-0 z-40 flex items-center justify-center">
        <div class="modal-content w-full max-w-2xl bg-white rounded-lg shadow-xl p-6">
            <h3 class="text-2xl font-bold mb-4">Bulk Add Tasks</h3>
            <p class="text-gray-600 mb-4">Paste your indented list below. Use spaces for indentation to create the hierarchy.</p>
            <textarea id="bulk-add-textarea" rows="10" class="w-full p-2 border rounded-md bg-gray-50"></textarea>
            <div class="flex justify-end space-x-4 mt-4">
                <button id="cancel-bulk-add" class="px-4 py-2 rounded-md text-gray-700 bg-gray-200 hover:bg-gray-300">Cancel</button>
                <button id="confirm-bulk-add" class="btn-primary px-4 py-2 rounded-md font-semibold">Add Tasks</button>
            </div>
        </div>
    </div>
    
    <!-- Task Detail Modal -->
    <div id="task-detail-modal" class="modal hidden fixed inset-0 z-40 flex items-center justify-center">
        <div class="modal-content w-full max-w-3xl bg-white rounded-lg shadow-xl overflow-hidden">
            <div class="p-6">
                <h3 id="modal-task-name" class="text-2xl font-bold mb-4">Task Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold mb-2">Notes</h4>
                        <textarea id="modal-notes" rows="8" class="w-full p-2 border rounded-md bg-gray-50" placeholder="Add your notes here..."></textarea>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">Attachments</h4>
                        <div class="flex items-center mb-2">
                            <input type="text" id="modal-attachment-link" class="flex-grow p-2 border rounded-l-md" placeholder="Paste a link...">
                            <button id="add-attachment-btn" class="btn-primary px-3 py-2 rounded-r-md"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="modal-attachments-list" class="space-y-2 max-h-48 overflow-y-auto no-scrollbar"></div>
                    </div>
                </div>
                <div id="youtube-player-container" class="mt-4 hidden">
                    <div id="youtube-player"></div>
                    <button id="play-in-background-btn" class="btn-primary mt-2 px-4 py-2 rounded-md text-sm">Play in Background</button>
                </div>
            </div>
            <div class="bg-gray-100 px-6 py-3 flex justify-end space-x-4">
                 <button id="save-task-details" class="btn-primary px-4 py-2 rounded-md font-semibold">Save & Close</button>
            </div>
        </div>
    </div>
    
    <audio id="background-audio"></audio>

    <script type="module">
        // 1. Firebase SDK Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, writeBatch, serverTimestamp, getDoc, setDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 2. The Firebase Configuration Object
        const firebaseConfig = {
            apiKey: "AIzaSyCKcC_TPxyP9-ErqUTZHWc4Il8llwpwUg8",
            authDomain: "forge23-04-2019.firebaseapp.com",
            projectId: "forge23-04-2019",
            storageBucket: "forge23-04-2019.appspot.com",
            messagingSenderId: "725283917440",
            appId: "1:725283917440:web:3627779e1de23153af2065"
        };

        // 3. Firebase Initialization
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global state
        let currentUserId = null;
        let tasks = [];
        let unsubscribeTasks = null;
        let unsubscribeSettings = null;
        
        const appEl = document.getElementById('app');
        const loaderEl = document.getElementById('app-loader');
        const accessDeniedEl = document.getElementById('access-denied');
        const taskListEl = document.getElementById('task-list');
        const headerTitle = document.getElementById('header-title');

        // 4. The Authentication State Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                appEl.classList.remove('hidden');
                loaderEl.style.display = 'none';
                accessDeniedEl.classList.add('hidden');
                
                if (unsubscribeTasks) unsubscribeTasks();
                if (unsubscribeSettings) unsubscribeSettings();

                getTasks(user.uid);
                getSettings(user.uid);
            } else {
                currentUserId = null;
                appEl.classList.add('hidden');
                loaderEl.style.display = 'none';
                accessDeniedEl.classList.remove('hidden');
                if (unsubscribeTasks) unsubscribeTasks();
                if (unsubscribeSettings) unsubscribeSettings();
            }
        });
        
        // --- DATA FETCHING & RENDERING ---
        
        function getTasks(userId) {
            const tasksRef = collection(db, 'users', userId, 'tasks');
            const q = query(tasksRef, orderBy('order'));
            
            setSyncStatus('syncing');
            unsubscribeTasks = onSnapshot(q, (snapshot) => {
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTaskList();
                updateMasterProgress();
                setSyncStatus('synced');
            }, (error) => {
                console.error("Error fetching tasks:", error);
                setSyncStatus('error');
            });
        }

        function getSettings(userId) {
            const settingsRef = doc(db, 'users', userId, 'settings');
            unsubscribeSettings = onSnapshot(settingsRef, (doc) => {
                if (doc.exists()) {
                    const settings = doc.data();
                    if (settings.theme) {
                        applyTheme(settings.theme);
                    }
                    if(settings.version) {
                        headerTitle.textContent = `PRODUCTIVITY HUB ${settings.version.toString().padStart(2, '0')}`;
                    }
                } else {
                    // Initialize settings if they don't exist
                    setDoc(settingsRef, { theme: 'theme-default', version: 1 });
                }
            });
        }

        function renderTaskList() {
            taskListEl.innerHTML = '';
            const taskMap = new Map(tasks.map(t => [t.id, {...t, children: []}]));
            
            const rootTasks = [];
            for(const task of taskMap.values()){
                if(task.parentId){
                    const parent = taskMap.get(task.parentId);
                    if(parent) parent.children.push(task);
                } else {
                    rootTasks.push(task);
                }
            }
            
            rootTasks.forEach(task => {
                const taskElement = createTaskElement(task);
                taskListEl.appendChild(taskElement);
                renderChildren(task, taskElement);
            });
        }

        function renderChildren(parentTask, parentElement) {
            const container = parentElement.querySelector('.children-container');
            if (!container) return;
            
            container.innerHTML = '';
            parentTask.children.sort((a, b) => a.order - b.order).forEach(childTask => {
                const childElement = createTaskElement(childTask);
                container.appendChild(childElement);
                renderChildren(childTask, childElement);
            });
        }

        function createTaskElement(task) {
            const isParent = tasks.some(t => t.parentId === task.id);
            const canHaveChildren = task.level < 3;

            const element = document.createElement('div');
            element.className = `task-item bg-white rounded-lg shadow p-3 level-${task.level} ${task.flagged ? 'flagged' : ''}`;
            element.dataset.id = task.id;
            
            const subjectProgress = task.level === 0 ? getSubjectProgress(task.id) : -1;

            element.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center flex-grow">
                        <i class="fas fa-chevron-right text-gray-400 mr-2 cursor-pointer ${isParent ? '' : 'invisible'}"></i>
                        <input type="checkbox" class="mr-3 h-5 w-5 rounded text-blue-600 focus:ring-blue-500" ${task.completed ? 'checked' : ''}>
                        <span class="task-name flex-grow ${task.completed ? 'line-through text-gray-500' : ''}">${task.name}</span>
                    </div>
                    <div class="task-controls flex items-center space-x-3 text-gray-500">
                        ${canHaveChildren ? '<button class="control-btn add-child-btn"><i class="fas fa-plus"></i></button>' : ''}
                        <button class="control-btn flag-btn"><i class="fas fa-flag ${task.flagged ? 'text-yellow-500' : ''}"></i></button>
                        <button class="control-btn notes-btn"><i class="fas fa-note-sticky"></i></button>
                        <button class="control-btn delete-btn"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                ${task.level === 0 ? `
                <div class="mt-2 pl-8">
                    <div class="progress-container w-full bg-gray-200 rounded-full h-2.5">
                        <div class="progress-bar h-2.5 rounded-full" style="width: ${subjectProgress}%;"></div>
                    </div>
                </div>
                ` : ''}
                <div class="children-container mt-2"></div>
            `;

            // Add event listeners
            element.querySelector('.fa-chevron-right').addEventListener('click', (e) => toggleCollapse(e, task.id));
            element.querySelector('input[type="checkbox"]').addEventListener('change', (e) => toggleComplete(task.id, e.target.checked));
            element.querySelector('.task-name').addEventListener('click', () => editTaskName(element.querySelector('.task-name'), task.id));
            element.querySelector('.delete-btn')?.addEventListener('click', () => deleteTask(task.id));
            element.querySelector('.add-child-btn')?.addEventListener('click', () => addChildTask(task.id, task.level + 1));
            element.querySelector('.flag-btn').addEventListener('click', () => toggleFlag(task.id, !task.flagged));
            element.querySelector('.notes-btn').addEventListener('click', () => openTaskDetailModal(task.id));

            return element;
        }


        // --- TASK MANIPULATION ---
        
        document.getElementById('add-subject-btn').addEventListener('click', async () => {
            const name = prompt("Enter new subject name:");
            if(name && name.trim()) {
                setSyncStatus('syncing');
                await addDoc(collection(db, 'users', currentUserId, 'tasks'), {
                    name: name.trim(),
                    completed: false,
                    level: 0,
                    parentId: null,
                    order: tasks.filter(t => t.level === 0).length,
                    createdAt: serverTimestamp()
                });
                setSyncStatus('synced');
            }
        });

        async function addChildTask(parentId, level) {
            const name = prompt(`Enter name for new item:`);
            if (name && name.trim()) {
                setSyncStatus('syncing');
                const parentTask = tasks.find(t => t.id === parentId);
                const childrenCount = tasks.filter(t => t.parentId === parentId).length;
                await addDoc(collection(db, 'users', currentUserId, 'tasks'), {
                    name: name.trim(),
                    completed: false,
                    level: level,
                    parentId: parentId,
                    order: childrenCount,
                    createdAt: serverTimestamp()
                });
                setSyncStatus('synced');
            }
        }

        async function editTaskName(element, taskId) {
            const currentName = element.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'w-full p-1 border rounded';
            
            element.replaceWith(input);
            input.focus();

            input.addEventListener('blur', async () => {
                const newName = input.value.trim();
                if (newName && newName !== currentName) {
                    setSyncStatus('syncing');
                    await updateDoc(doc(db, 'users', currentUserId, 'tasks', taskId), { name: newName });
                    setSyncStatus('synced');
                }
                // The onSnapshot listener will handle re-rendering
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                }
            });
        }

        async function deleteTask(taskId) {
            if (!confirm("Are you sure you want to delete this task and all its sub-tasks?")) return;

            setSyncStatus('syncing');
            const batch = writeBatch(db);
            const descendants = getDescendants(taskId, true);
            descendants.forEach(task => {
                batch.delete(doc(db, 'users', currentUserId, 'tasks', task.id));
            });
            await batch.commit();
            setSyncStatus('synced');
        }
        
        async function toggleFlag(taskId, flagged) {
            setSyncStatus('syncing');
            await updateDoc(doc(db, 'users', currentUserId, 'tasks', taskId), { flagged });
            setSyncStatus('synced');
        }

        // --- COMPLETION LOGIC ---

        async function toggleComplete(taskId, isCompleted) {
            setSyncStatus('syncing');
            const batch = writeBatch(db);
            const task = tasks.find(t => t.id === taskId);
            
            // Top-down completion
            const descendants = getDescendants(taskId, false);
            descendants.forEach(d => {
                batch.update(doc(db, 'users', currentUserId, 'tasks', d.id), { completed: isCompleted });
            });
            batch.update(doc(db, 'users', currentUserId, 'tasks', taskId), { completed: isCompleted });

            // Bottom-up completion/un-completion
            let currentParentId = task.parentId;
            while(currentParentId) {
                const parent = tasks.find(t => t.id === currentParentId);
                const siblings = tasks.filter(t => t.parentId === currentParentId);
                
                if(isCompleted) {
                    // Check if all siblings (including current) are now complete
                    const allSiblingsCompleted = siblings.every(s => {
                        const descendantIds = getDescendants(s.id, true).map(d => d.id);
                        const selfAndDescendants = [s, ...tasks.filter(t => descendantIds.includes(t.id))];
                        return selfAndDescendants.every(item => item.completed || item.id === taskId);
                    });

                    if (allSiblingsCompleted) {
                         batch.update(doc(db, 'users', currentUserId, 'tasks', currentParentId), { completed: true });
                    }
                } else {
                    // If un-checking, un-check all parents
                    batch.update(doc(db, 'users', currentUserId, 'tasks', currentParentId), { completed: false });
                }
                currentParentId = parent.parentId;
            }
            
            await batch.commit();
            setSyncStatus('synced');
        }


        // --- PROGRESS BARS ---
        function updateMasterProgress() {
            const subjects = tasks.filter(t => t.level === 0);
            if (subjects.length === 0) {
                document.getElementById('master-progress-bar').style.width = '0%';
                return;
            }
            const completedSubjects = subjects.filter(s => s.completed).length;
            const progress = (completedSubjects / subjects.length) * 100;
            document.getElementById('master-progress-bar').style.width = `${progress}%`;
        }

        function getSubjectProgress(subjectId) {
            const descendants = getDescendants(subjectId, false);
            if (descendants.length === 0) {
                const subject = tasks.find(t => t.id === subjectId);
                return subject && subject.completed ? 100 : 0;
            }
            const topics = descendants.filter(d => !tasks.some(t => t.parentId === d.id));
            if (topics.length === 0) return 0;

            const completedTopics = topics.filter(t => t.completed).length;
            return (completedTopics / topics.length) * 100;
        }
        
        // --- BULK ADD MODAL ---
        const bulkAddModal = document.getElementById('bulk-add-modal');
        document.getElementById('bulk-add-btn').addEventListener('click', () => bulkAddModal.classList.remove('hidden'));
        document.getElementById('cancel-bulk-add').addEventListener('click', () => bulkAddModal.classList.add('hidden'));
        document.getElementById('confirm-bulk-add').addEventListener('click', handleBulkAdd);

        async function handleBulkAdd() {
            const text = document.getElementById('bulk-add-textarea').value;
            if (!text.trim()) return;

            setSyncStatus('syncing');
            const lines = text.split('\n').filter(line => line.trim() !== '');
            const batch = writeBatch(db);
            const parentStack = [];
            let lastLevel = -1;
            
            const rootOrder = tasks.filter(t => t.level === 0).length;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const indentation = line.match(/^\s*/)[0].length;
                const name = line.trim();
                const level = Math.floor(indentation / 2); // Assuming 2 spaces per indent level

                while (level <= lastLevel && parentStack.length > 0) {
                    parentStack.pop();
                    lastLevel--;
                }
                
                const parentId = parentStack.length > 0 ? parentStack[parentStack.length - 1] : null;
                
                const siblingCount = tasks.filter(t => t.parentId === parentId).length + 
                                     lines.slice(0, i).filter(l => (l.match(/^\s*/)[0].length / 2) === level).length;

                const newDocRef = doc(collection(db, 'users', currentUserId, 'tasks'));
                batch.set(newDocRef, {
                    name: name,
                    completed: false,
                    level: parentId ? tasks.find(t => t.id === parentId).level + 1 : 0,
                    parentId: parentId,
                    order: parentId ? siblingCount : rootOrder + i,
                    createdAt: serverTimestamp()
                });
                parentStack.push(newDocRef.id);
                lastLevel = level;
            }

            await batch.commit();
            document.getElementById('bulk-add-textarea').value = '';
            bulkAddModal.classList.add('hidden');
            setSyncStatus('synced');
        }

        // --- TASK DETAIL MODAL ---
        const taskDetailModal = document.getElementById('task-detail-modal');
        let currentEditingTaskId = null;

        async function openTaskDetailModal(taskId) {
            currentEditingTaskId = taskId;
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            document.getElementById('modal-task-name').textContent = task.name;
            document.getElementById('modal-notes').value = task.notes || '';
            
            // Render attachments
            const attachmentsList = document.getElementById('modal-attachments-list');
            attachmentsList.innerHTML = '';
            if (task.attachments) {
                task.attachments.forEach((link, index) => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center justify-between bg-gray-100 p-2 rounded';
                    el.innerHTML = `<a href="${link}" target="_blank" class="truncate text-blue-600 hover:underline">${link}</a><button data-index="${index}" class="remove-attachment-btn text-red-500 ml-2"><i class="fas fa-times"></i></button>`;
                    attachmentsList.appendChild(el);
                });
            }

            taskDetailModal.classList.remove('hidden');
        }
        
        document.getElementById('save-task-details').addEventListener('click', async () => {
            if (!currentEditingTaskId) return;

            setSyncStatus('syncing');
            const notes = document.getElementById('modal-notes').value;
            const task = tasks.find(t => t.id === currentEditingTaskId);
            const attachments = task.attachments || [];

            await updateDoc(doc(db, 'users', currentUserId, 'tasks', currentEditingTaskId), {
                notes,
                attachments
            });
            
            taskDetailModal.classList.add('hidden');
            currentEditingTaskId = null;
            setSyncStatus('synced');
        });

        document.getElementById('add-attachment-btn').addEventListener('click', async () => {
            const linkInput = document.getElementById('modal-attachment-link');
            const link = linkInput.value.trim();
            if (!link) return;
            
            const task = tasks.find(t => t.id === currentEditingTaskId);
            const newAttachments = [...(task.attachments || []), link];
            
            await updateDoc(doc(db, 'users', currentUserId, 'tasks', currentEditingTaskId), { attachments: newAttachments });
            linkInput.value = '';
            openTaskDetailModal(currentEditingTaskId); // Re-render modal
        });

        document.getElementById('modal-attachments-list').addEventListener('click', async (e) => {
            if (e.target.closest('.remove-attachment-btn')) {
                const button = e.target.closest('.remove-attachment-btn');
                const index = parseInt(button.dataset.index);
                
                const task = tasks.find(t => t.id === currentEditingTaskId);
                const newAttachments = task.attachments.filter((_, i) => i !== index);

                await updateDoc(doc(db, 'users', currentUserId, 'tasks', currentEditingTaskId), { attachments: newAttachments });
                openTaskDetailModal(currentEditingTaskId); // Re-render modal
            }
        });


        // --- UTILITY & UI ---
        
        function setSyncStatus(status) {
            const syncIcon = document.getElementById('sync-icon');
            const syncStatus = document.getElementById('sync-status');
            syncIcon.className = 'fas';
            switch(status) {
                case 'syncing':
                    syncIcon.classList.add('fa-spin', 'fa-sync-alt', 'text-blue-500');
                    syncStatus.textContent = 'Syncing...';
                    break;
                case 'synced':
                    syncIcon.classList.add('fa-check-circle', 'text-green-500');
                    syncStatus.textContent = 'Synced';
                    break;
                case 'error':
                    syncIcon.classList.add('fa-exclamation-circle', 'text-red-500');
                    syncStatus.textContent = 'Error';
                    break;
            }
        }
        
        function getDescendants(parentId, includeSelf = false) {
            let descendants = [];
            if(includeSelf) {
                const self = tasks.find(t => t.id === parentId);
                if(self) descendants.push(self);
            }

            const children = tasks.filter(t => t.parentId === parentId);
            for (const child of children) {
                descendants.push(child);
                descendants = descendants.concat(getDescendants(child.id, false));
            }
            return descendants;
        }

        document.getElementById('quit-btn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Sign out error', error);
            });
        });

        // Theme switcher
        document.querySelectorAll('.theme-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const theme = btn.dataset.theme;
                applyTheme(theme);
                if (currentUserId) {
                    setDoc(doc(db, 'users', currentUserId, 'settings'), { theme }, { merge: true });
                }
            });
        });

        function applyTheme(theme) {
            document.body.className = theme;
        }
        
        // Header version update simulation (for demo)
        headerTitle.addEventListener('click', async () => {
            if(!currentUserId) return;
            const settingsDoc = await getDoc(doc(db, 'users', currentUserId, 'settings'));
            let currentVersion = settingsDoc.exists() ? settingsDoc.data().version || 1 : 1;
            await setDoc(doc(db, 'users', currentUserId, 'settings'), { version: currentVersion + 1 }, { merge: true });
        });

        function toggleCollapse(event, taskId) {
            const icon = event.target;
            const taskElement = icon.closest('.task-item');
            const childrenContainer = taskElement.querySelector('.children-container');
            
            icon.classList.toggle('fa-chevron-down');
            icon.classList.toggle('fa-chevron-right');
            childrenContainer.classList.toggle('hidden');
        }

    </script>
</body>
</html>
