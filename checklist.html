<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productivity Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Orbitron:wght@700&family=Roboto+Condensed:wght@700&family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --main-bg: #f4f4f4; --surface-color: #ffffff; --text-color: #333333; --text-muted-color: #777;
            --primary-color: #0D47A1; --secondary-color: #00796B; --accent-color: #D84315; --border-color: #cccccc;
            --danger-color: #c62828; --main-font: 'VT323', monospace; --header-font: 'VT323', monospace;
            --button-radius: 0px; --special-bg: var(--main-bg);
            --progress-bar-gradient: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
        }
        body.theme-wonder-woman {
            --main-bg: #002266; --surface-color: #003366; --text-color: #FFD700; --text-muted-color: #c0c0c0;
            --primary-color: #FFD700; --secondary-color: #C00000; --accent-color: #FFD700; --border-color: #FFD700;
            --danger-color: #8B0000; --main-font: 'Cinzel', serif; --header-font: 'Cinzel', serif;
            --button-radius: 4px; --special-bg: var(--main-bg);
            --progress-bar-gradient: linear-gradient(90deg, #C00000, #FFD700);
        }
        body.theme-iron-man {
            --main-bg: #2E2E2E; --surface-color: #1a1a1a; --text-color: #00FFFF; --text-muted-color: #B2BABB;
            --primary-color: #B22222; --secondary-color: #00FFFF; --accent-color: #00FFFF; --border-color: #00FFFF;
            --danger-color: #800000; --main-font: 'Orbitron', sans-serif; --header-font: 'Orbitron', sans-serif;
            --button-radius: 2px; --special-bg: repeating-conic-gradient(var(--main-bg) 0% 25%, #333 0% 50%) 50% / 20px 20px;
            --progress-bar-gradient: linear-gradient(90deg, #00FFFF, #00a1a1);
        }
        body.theme-batman {
            --main-bg: #121212; --surface-color: #1a1a1a; --text-color: #F5DE50; --text-muted-color: #8b949e;
            --primary-color: #F5DE50; --secondary-color: #708090; --accent-color: #F5DE50; --border-color: #F5DE50;
            --danger-color: #444; --main-font: 'Roboto Condensed', sans-serif; --header-font: 'Roboto Condensed', sans-serif;
            --button-radius: 0px; --special-bg: var(--main-bg);
            --progress-bar-gradient: linear-gradient(90deg, #F5DE50, #F5DE50);
        }

        body {
            background-color: var(--main-bg);
            background-image: var(--special-bg);
            color: var(--text-color);
            font-family: var(--main-font);
            transition: background-color 0.5s;
        }
        h1, h2, h3, h4, h5, h6 { font-family: var(--header-font); }
        .surface { background-color: var(--surface-color); border: 2px solid var(--border-color); }
        .text-muted { color: var(--text-muted-color); }
        .retro-btn {
            background-color: transparent; border: 2px solid var(--primary-color); color: var(--primary-color);
            padding: 8px 12px; text-transform: uppercase; cursor: pointer; transition: all 0.2s;
            font-weight: bold; border-radius: var(--button-radius);
        }
        .retro-btn:hover { background-color: var(--primary-color); color: var(--main-bg); }
        .retro-btn.secondary { border-color: var(--secondary-color); color: var(--secondary-color); }
        .retro-btn.secondary:hover { background-color: var(--secondary-color); color: var(--main-bg); }
        .progress-bar-container { border: 2px solid var(--border-color); background-color: rgba(0,0,0,0.2); padding: 2px; }
        .progress-bar { background-image: var(--progress-bar-gradient); }
        .subject-progress-bar { background-color: var(--secondary-color); }
        .theme-switcher-btn { padding: 4px 8px; border: 1px solid var(--text-color); cursor: pointer; opacity: 0.6; }
        .theme-switcher-btn.active { opacity: 1; background-color: var(--text-color); color: var(--main-bg); }
        .modal-content { background-color: var(--main-bg); border: 2px solid var(--text-color); }
        .calendar-day.today { border: 2px solid var(--primary-color); border-radius: 50%; }
        .calendar-day.bookmarked { box-shadow: 0 0 0 2px var(--accent-color) inset; border-radius: 4px; }
        
        .custom-checkbox {
            width: 24px; height: 24px; border: 2px solid var(--secondary-color); cursor: pointer;
            position: relative; flex-shrink: 0; display: flex; align-items: center; justify-content: center;
            transition: background-color 0.2s;
        }
        .custom-checkbox.checked { background-color: var(--accent-color); border-color: var(--accent-color); }
        .custom-checkbox.checked::after {
            content: 'âœ“'; font-size: 20px; font-weight: bold; color: var(--main-bg);
            position: absolute; top: -2px;
        }
        
        .collapse-icon { transition: transform 0.2s ease-in-out; }
        .collapsed .collapse-icon { transform: rotate(-90deg); }
        .completed-task > span { text-decoration: line-through; color: var(--text-muted-color); }
        .dragging { opacity: 0.5; }
        .drag-over { border-top: 2px solid var(--primary-color); }
        #video-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10; pointer-events: none; }
        #video-background iframe { width: 100%; height: 100%; }
    </style>
</head>
<body class="theme-classic">

    <div id="video-background" class="hidden"></div>
    <button id="close-video-bg-btn" class="hidden fixed top-4 right-28 z-50 retro-btn secondary">Close Video</button>

    <div id="logged-out-view" class="hidden h-screen flex items-center justify-center p-4">
        <div class="surface p-12 space-y-4 text-center">
            <h2 class="text-3xl">ACCESS DENIED</h2>
            <p class="text-muted">Please log in to access your Productivity Hub.</p>
            <a href="index.html" class="retro-btn inline-block">GO TO LOGIN</a>
        </div>
    </div>

    <div id="logged-in-view" class="hidden opacity-0 transition-opacity duration-500">
        <header class="p-4 flex justify-between items-center border-b-2" style="border-color: var(--border-color);">
            <h1 class="text-3xl">PRODUCTIVITY HUB</h1>
            <div class="flex items-center gap-4">
                <a href="focus.html" class="retro-btn">FORGE</a>
                <div id="theme-switcher" class="flex items-center space-x-1"></div>
                <div id="save-status" class="text-sm text-muted"></div>
                <button id="sign-out-btn" class="retro-btn secondary">QUIT</button>
            </div>
        </header>

        <div class="flex flex-col md:flex-row">
            <!-- Sidebar -->
            <aside class="w-full md:w-1/3 lg:w-1/4 p-4 space-y-6 border-b-2 md:border-b-0 md:border-r-2" style="border-color: var(--border-color);">
                <div class="surface p-4">
                    <h2 class="text-xl mb-2">STOPWATCH</h2>
                    <p id="stopwatch-display" class="text-5xl text-center font-mono">00:00:00</p>
                    <div class="flex justify-center gap-2 mt-4">
                        <button id="start-pause-stopwatch-btn" class="retro-btn w-24">START</button>
                        <button id="reset-stopwatch-btn" class="retro-btn secondary w-24">RESET</button>
                    </div>
                </div>
                <div class="surface p-4">
                    <h2 class="text-xl mb-2">ACHIEVEMENTS</h2>
                    <div class="border-2 p-4 text-center" style="border-color: var(--secondary-color);">
                        <i class="fas fa-shield-halved text-4xl" style="color: var(--primary-color);"></i>
                        <h3 class="font-bold mt-2">THE PILLAR - LVL 0</h3>
                        <p class="text-sm text-muted">Your discipline builds the foundation.</p>
                    </div>
                </div>
                <div class="surface p-4">
                    <div class="flex justify-between items-center mb-2">
                        <button id="prev-month-btn" class="retro-btn secondary">&lt;</button>
                        <h2 id="calendar-header" class="text-xl"></h2>
                        <button id="next-month-btn" class="retro-btn secondary">&gt;</button>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center text-sm mb-2"></div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="w-full md:w-2/3 lg:w-3/4 p-4 space-y-6">
                <div class="flex items-center gap-4">
                    <input type="text" id="search-input" placeholder="SEARCH TASKS..." class="flex-grow p-2 surface text-xl">
                    <button id="global-bulk-add-btn" class="retro-btn secondary">BULK ADD</button>
                    <button id="add-subject-btn" class="retro-btn">ADD SUBJECT</button>
                </div>
                <div class="surface p-4">
                    <div class="flex justify-between items-center mb-2">
                         <h2 class="text-xl">MASTER CHECKLIST</h2>
                         <span id="progress-text" class="text-sm font-bold text-muted">0%</span>
                    </div>
                    <div class="progress-bar-container mb-4">
                        <div id="progress-bar" class="progress-bar h-full"><span id="progress-bar-text" class="progress-text"></span></div>
                    </div>
                    <div id="task-list-container" class="space-y-4 max-h-[60vh] overflow-y-auto no-scrollbar pr-2">
                        <p id="loading-placeholder" class="text-muted">LOADING...</p>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="modal-container" class="hidden fixed inset-0 flex items-center justify-center p-4">
        <div id="modal-content" class="modal-content w-full max-w-2xl p-6 space-y-4"></div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, writeBatch, serverTimestamp, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCKcC_TPxyP9-ErqUTZHWc4Il8llwpwUg8",
            authDomain: "forge23-04-2019.firebaseapp.com",
            projectId: "forge23-04-2019",
            storageBucket: "forge23-04-2019.appspot.com",
            messagingSenderId: "725283917440",
            appId: "1:725283917440:web:3627779e1de23153af2065"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- UI & State Variables ---
        const loggedInView = document.getElementById('logged-in-view');
        const loggedOutView = document.getElementById('logged-out-view');
        const signOutBtn = document.getElementById('sign-out-btn');
        const searchInput = document.getElementById('search-input');
        const addSubjectBtn = document.getElementById('add-subject-btn');
        const taskListContainer = document.getElementById('task-list-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const progressBarText = document.getElementById('progress-bar-text');
        const saveStatus = document.getElementById('save-status');
        
        // Calendar
        const calendarGrid = document.getElementById('calendar-grid');
        const calendarHeader = document.getElementById('calendar-header');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        
        // Stopwatch
        const stopwatchDisplay = document.getElementById('stopwatch-display');
        const startPauseStopwatchBtn = document.getElementById('start-pause-stopwatch-btn');
        const resetStopwatchBtn = document.getElementById('reset-stopwatch-btn');
        
        // Modals
        const modalContainer = document.getElementById('modal-container');
        const modalContent = document.getElementById('modal-content');
        const globalBulkAddBtn = document.getElementById('global-bulk-add-btn');

        // Theme
        const themeSwitcher = document.getElementById('theme-switcher');
        
        // Video Background
        const videoBackground = document.getElementById('video-background');
        const closeVideoBgBtn = document.getElementById('close-video-bg-btn');

        let tasksUnsubscribe = null;
        let settingsUnsubscribe = null;
        let allTasks = [];
        const HIERARCHY = ['Subject', 'Section', 'Chapter', 'Topic'];
        let currentCalendarDate = new Date();
        let bookmarkedDate = null;

        let stopwatchInterval = null;
        let stopwatchSeconds = 0;
        let isStopwatchRunning = false;
        let saveTimeout;
        
        // --- Auth State ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loggedInView.classList.remove('hidden');
                setTimeout(() => loggedInView.classList.remove('opacity-0'), 50);
                loggedOutView.classList.add('hidden');
                getTasks(user.uid);
                getSettings(user.uid);
            } else {
                loggedInView.classList.add('hidden', 'opacity-0');
                loggedOutView.classList.remove('hidden');
                if (tasksUnsubscribe) tasksUnsubscribe();
                if (settingsUnsubscribe) settingsUnsubscribe();
                clearInterval(stopwatchInterval);
            }
        });

        // --- Settings (Theme) ---
        const getSettings = (userId) => {
            const settingsRef = doc(db, 'users', userId, 'settings', 'userSettings');
            settingsUnsubscribe = onSnapshot(settingsRef, (doc) => {
                const settings = doc.exists() ? doc.data() : {};
                applyTheme(settings.theme || 'classic', settings.themeNames || {});
            });
        };

        const applyTheme = (themeName, themeNames) => {
            document.body.className = `theme-${themeName}`;
            const defaultNames = { classic: 'C', 'wonder-woman': 'W', 'iron-man': 'I', 'batman': 'B' };
            const themes = ['classic', 'wonder-woman', 'iron-man', 'batman'];
            themeSwitcher.innerHTML = themes.map(t => {
                const name = (themeNames && themeNames[t]) ? themeNames[t] : defaultNames[t];
                return `<button data-theme="${t}" class="theme-switcher-btn ${t === themeName ? 'active' : ''}" title="${t}" contenteditable="true" spellcheck="false">${name}</button>`
            }).join('');
        };

        const saveTheme = (themeName) => {
            const user = auth.currentUser; if (!user) return;
            const settingsRef = doc(db, 'users', user.uid, 'settings', 'userSettings');
            setDoc(settingsRef, { theme: themeName }, { merge: true });
        };
        
        const saveThemeName = (themeId, newName) => {
            const user = auth.currentUser; if (!user) return;
            const settingsRef = doc(db, 'users', user.uid, 'settings', 'userSettings');
            setDoc(settingsRef, { themeNames: { [themeId]: newName } }, { merge: true });
        };


        // --- Data Handling & Rendering ---
        const getTasks = (userId) => {
            const q = query(collection(db, 'users', userId, 'tasks'));
            tasksUnsubscribe = onSnapshot(q, (snapshot) => {
                allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                handleSearch();
                updateMasterProgressBar();
                renderCalendar();
            });
        };

        const buildTree = (tasks, parentId = null) => {
            return tasks
                .filter(task => task.parentId === parentId)
                .map(task => ({ ...task, children: buildTree(tasks, task.id) }));
        };

        const renderTaskTree = (taskTree) => {
            taskListContainer.innerHTML = '';
            if (taskTree.length === 0) {
                taskListContainer.innerHTML = `<p class="text-muted">NO TASKS FOUND. ADD A SUBJECT TO BEGIN.</p>`;
                return;
            }
            taskTree.forEach(taskNode => renderTask(taskNode, 0));
        };

        const renderTask = (taskNode, level) => {
            const taskEl = document.createElement('div');
            taskEl.setAttribute('data-id', taskNode.id);
            taskEl.setAttribute('draggable', true);
            taskEl.className = `task-item-container ${taskNode.isCollapsed ? 'collapsed' : ''}`;
            
            const hasChildren = taskNode.children && taskNode.children.length > 0;
            const isMaxDepth = level >= HIERARCHY.length - 1;

            const checkboxClass = `custom-checkbox ${taskNode.completed ? 'checked' : ''}`;
            
            let subjectProgressBarHTML = '';
            if (level === 0) {
                const descendantIds = getDescendantIds(taskNode.id, allTasks);
                const relevantTasks = allTasks.filter(t => descendantIds.includes(t.id));
                const completedCount = relevantTasks.filter(t => t.completed).length;
                const subjectProgress = relevantTasks.length > 0 ? (completedCount / relevantTasks.length) * 100 : 0;
                subjectProgressBarHTML = `
                    <div class="progress-bar-container mt-2 h-2">
                        <div class="subject-progress-bar h-full" style="width: ${subjectProgress}%"></div>
                    </div>`;
            }

            taskEl.innerHTML = `
                <div class="task-item group p-2 rounded-lg flex items-center gap-2 surface" style="border-color: var(--secondary-color);">
                    <i class="collapse-icon fa-solid fa-chevron-down w-4 text-center text-muted ${hasChildren ? '' : 'invisible'}"></i>
                    <div class="${checkboxClass}"></div>
                    <span class="flex-grow font-bold text-lg ${taskNode.completed ? 'completed-task' : ''}" contenteditable="true" spellcheck="false">${taskNode.text}</span>
                    <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button title="Add ${isMaxDepth ? '' : HIERARCHY[level+1]}" class="add-subtask-btn text-muted hover:text-green-500 ${isMaxDepth ? 'hidden' : ''}"><i class="fas fa-plus-circle"></i></button>
                        <button title="Flag" class="flag-btn text-muted hover:text-yellow-500 ${taskNode.isFlagged ? 'text-yellow-500' : ''}"><i class="fas fa-flag"></i></button>
                        <button title="Notes" class="notes-btn text-muted hover:text-blue-500"><i class="far fa-sticky-note"></i></button>
                        <button title="Delete" class="delete-btn text-muted hover:text-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                ${subjectProgressBarHTML}
                <div class="children-container pl-6 border-l-2 ml-3" style="border-color: var(--border-color);"></div>
            `;
            taskListContainer.appendChild(taskEl);

            const span = taskEl.querySelector('span');
            span.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); span.blur(); } });
            span.addEventListener('blur', () => updateTaskText(taskNode.id, span.textContent));
            taskEl.querySelector('.collapse-icon').addEventListener('click', () => toggleCollapse(taskNode.id, !taskNode.isCollapsed));
            taskEl.querySelector('.custom-checkbox').addEventListener('click', () => toggleTaskCompleteWithChildren(taskNode.id, !taskNode.completed));
            taskEl.querySelector('.add-subtask-btn').addEventListener('click', () => addTask(HIERARCHY[level + 1], taskNode.id, level + 1));
            taskEl.querySelector('.flag-btn').addEventListener('click', () => toggleFlag(taskNode.id, !taskNode.isFlagged));
            taskEl.querySelector('.notes-btn').addEventListener('click', () => openNotesModal(taskNode.id));
            taskEl.querySelector('.delete-btn').addEventListener('click', () => deleteTaskWithChildren(taskNode.id));

            taskEl.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', taskNode.id); e.currentTarget.classList.add('dragging'); });
            taskEl.addEventListener('dragend', e => e.currentTarget.classList.remove('dragging'));
            taskEl.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.classList.add('drag-over'); });
            taskEl.addEventListener('dragleave', e => e.currentTarget.classList.remove('drag-over'));
            taskEl.addEventListener('drop', e => { e.preventDefault(); e.currentTarget.classList.remove('drag-over'); handleDrop(e.dataTransfer.getData('text/plain'), taskNode.id); });

            if (hasChildren && !taskNode.isCollapsed) {
                const childrenContainer = taskEl.querySelector('.children-container');
                taskNode.children.forEach(childNode => {
                    const childEl = renderTask(childNode, level + 1);
                    childrenContainer.appendChild(childEl);
                });
            }
            return taskEl;
        };
        
        const updateMasterProgressBar = () => {
            const subjects = allTasks.filter(t => t.parentId === null);
            if (subjects.length === 0) {
                progressBar.style.width = '0%';
                progressText.textContent = '0%';
                progressBarText.textContent = '';
                return;
            }
            const completedSubjects = subjects.filter(s => {
                const descendantIds = getDescendantIds(s.id, allTasks);
                if (descendantIds.length === 0) return s.completed;
                const descendants = allTasks.filter(t => descendantIds.includes(t.id));
                return descendants.length > 0 && descendants.every(d => d.completed);
            }).length;
            const percentage = Math.round((completedSubjects / subjects.length) * 100);
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `${percentage}%`;
            progressBarText.textContent = `${completedSubjects}/${subjects.length} SUBJECTS`;
        };
        
        const getDescendantIds = (parentId, tasks) => {
            let descendants = [];
            const children = tasks.filter(task => task.parentId === parentId);
            children.forEach(child => {
                descendants.push(child.id);
                descendants = descendants.concat(getDescendantIds(child.id, tasks));
            });
            return descendants;
        };

        // --- Firestore Actions ---
        const showSaveStatus = () => {
            saveStatus.textContent = 'SAVING...';
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => { saveStatus.textContent = 'SYNCED'; }, 1500);
        };

        const addTask = (text, parentId = null, level = 0) => {
            const user = auth.currentUser; if (!user) return;
            showSaveStatus();
            addDoc(collection(db, 'users', user.uid, 'tasks'), {
                text, parentId, level, completed: false, isFlagged: false, isCollapsed: false, notes: '', attachments: [], createdAt: serverTimestamp()
            });
        };
        
        const updateTask = (id, data) => {
            const user = auth.currentUser; if (!user) return;
            showSaveStatus();
            updateDoc(doc(db, 'users', user.uid, 'tasks', id), data);
        };
        const updateTaskText = (id, text) => updateTask(id, { text });
        const toggleFlag = (id, isFlagged) => updateTask(id, { isFlagged });
        const toggleCollapse = (id, isCollapsed) => updateTask(id, { isCollapsed });
        
        const toggleTaskCompleteWithChildren = (taskId, isCompleted) => {
            const user = auth.currentUser; if (!user) return;
            showSaveStatus();
            const batch = writeBatch(db);
            const taskMap = new Map(allTasks.map(task => [task.id, task]));
            const idsToUpdate = [taskId, ...getDescendantIds(taskId, allTasks)];
            idsToUpdate.forEach(id => {
                batch.update(doc(db, 'users', user.uid, 'tasks', id), { completed: isCompleted, completedAt: isCompleted ? serverTimestamp() : null });
            });
            let currentTask = taskMap.get(taskId);
            let parentId = currentTask ? currentTask.parentId : null;
            while (parentId) {
                const parent = taskMap.get(parentId);
                const siblings = allTasks.filter(t => t.parentId === parentId);
                const allSiblingsComplete = siblings.every(s => idsToUpdate.includes(s.id) ? isCompleted : s.completed);
                batch.update(doc(db, 'users', user.uid, 'tasks', parentId), { completed: allSiblingsComplete });
                parentId = parent.parentId;
            }
            batch.commit();
        };

        const deleteTaskWithChildren = (taskId) => {
            const user = auth.currentUser; if (!user) return;
            showSaveStatus();
            const idsToDelete = [taskId, ...getDescendantIds(taskId, allTasks)];
            const batch = writeBatch(db);
            idsToDelete.forEach(id => batch.delete(doc(db, 'users', user.uid, 'tasks', id)));
            batch.commit();
        };

        const handleDrop = (draggedId, targetId) => {
            const draggedTask = allTasks.find(t => t.id === draggedId);
            const targetTask = allTasks.find(t => t.id === targetId);
            if (!draggedTask || !targetTask || draggedId === targetId) return;
            if (getDescendantIds(draggedId, allTasks).includes(targetId)) return;
            updateTask(draggedId, { parentId: targetTask.parentId, level: targetTask.level });
        };

        const handleSearch = () => {
            const searchTerm = searchInput.value.trim().toLowerCase();
            const taskMap = new Map(allTasks.map(task => [task.id, task]));
            if (!searchTerm) {
                renderTaskTree(buildTree(allTasks));
                return;
            }
            const matchingIds = new Set();
            allTasks.forEach(task => {
                if (task.text.toLowerCase().includes(searchTerm)) {
                    let current = task;
                    while (current) {
                        matchingIds.add(current.id);
                        current = current.parentId ? taskMap.get(current.parentId) : null;
                    }
                }
            });
            const filteredTasks = allTasks.filter(task => matchingIds.has(task.id));
            renderTaskTree(buildTree(filteredTasks));
        };
        searchInput.addEventListener('input', handleSearch);

        // --- Stopwatch Logic ---
        const updateStopwatchDisplay = () => {
            const hours = Math.floor(stopwatchSeconds / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((stopwatchSeconds % 3600) / 60).toString().padStart(2, '0');
            const seconds = (stopwatchSeconds % 60).toString().padStart(2, '0');
            stopwatchDisplay.textContent = `${hours}:${minutes}:${seconds}`;
        };
        const startPauseStopwatch = () => {
            if (isStopwatchRunning) {
                clearInterval(stopwatchInterval);
                isStopwatchRunning = false;
                startPauseStopwatchBtn.textContent = 'RESUME';
            } else {
                isStopwatchRunning = true;
                startPauseStopwatchBtn.textContent = 'PAUSE';
                stopwatchInterval = setInterval(() => {
                    stopwatchSeconds++;
                    updateStopwatchDisplay();
                }, 1000);
            }
        };
        const resetStopwatch = () => {
            clearInterval(stopwatchInterval);
            isStopwatchRunning = false;
            stopwatchSeconds = 0;
            updateStopwatchDisplay();
            startPauseStopwatchBtn.textContent = 'START';
        };
        startPauseStopwatchBtn.addEventListener('click', startPauseStopwatch);
        resetStopwatchBtn.addEventListener('click', resetStopwatch);

        // --- Calendar Logic ---
        const renderCalendar = () => {
            calendarGrid.innerHTML = '';
            const month = currentCalendarDate.getMonth();
            const year = currentCalendarDate.getFullYear();
            calendarHeader.textContent = `${currentCalendarDate.toLocaleString('default', { month: 'long' })} ${year}`;
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const completionsByDate = {};
            allTasks.forEach(task => {
                if (task.completed && task.completedAt) {
                    const dateStr = task.completedAt.toDate().toISOString().split('T')[0];
                    completionsByDate[dateStr] = (completionsByDate[dateStr] || 0) + 1;
                }
            });
            const dayHeaders = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            dayHeaders.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'font-bold text-muted';
                dayEl.textContent = day;
                calendarGrid.appendChild(dayEl);
            });
            for (let i = 0; i < firstDayOfMonth; i++) { calendarGrid.appendChild(document.createElement('div')); }
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                const dateStr = new Date(year, month, day).toISOString().split('T')[0];
                dayEl.className = `p-1 calendar-day cursor-pointer`;
                const todayStr = new Date().toISOString().split('T')[0];
                if(dateStr === todayStr) { dayEl.classList.add('today'); }
                if(bookmarkedDate === dateStr) { dayEl.classList.add('bookmarked'); }
                const count = completionsByDate[dateStr] || 0;
                let level = 0;
                if (count > 0) level = 1; if (count > 2) level = 2; if (count > 5) level = 3; if (count > 8) level = 4;
                if (level > 0) { dayEl.style.backgroundColor = `rgba(16, 185, 129, ${level * 0.25})`; }
                dayEl.title = `${count} tasks on ${new Date(year, month, day).toDateString()}`;
                dayEl.addEventListener('click', () => {
                    bookmarkedDate = dateStr;
                    renderCalendar();
                });
                calendarGrid.appendChild(dayEl);
            }
        };
        prevMonthBtn.addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(); });
        nextMonthBtn.addEventListener('click', () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(); });

        // --- Modal Logic ---
        const showModal = (content) => {
            modalContent.innerHTML = content;
            modalContainer.classList.remove('hidden');
        };
        const closeModal = () => modalContainer.classList.add('hidden');

        const openNotesModal = (id) => {
            const task = allTasks.find(t => t.id === id); if (!task) return;
            const content = `
                <h3 class="text-xl font-bold mb-4">EDIT DETAILS</h3>
                <div id="modal-attachments-list" class="space-y-2 mt-2"></div>
                <div><label for="modal-notes" class="block text-sm font-medium">NOTES</label><textarea id="modal-notes" rows="4" class="mt-1 block w-full rounded-md shadow-sm surface border text-muted">${task.notes || ''}</textarea></div>
                <div class="mt-4"><label class="block text-sm font-medium">ATTACH YOUTUBE LINK</label><div class="flex gap-2 mt-2"><input type="url" id="new-attachment-input" placeholder="https://youtube.com/watch?v=..." class="flex-grow rounded-md shadow-sm surface border text-muted"><button id="add-attachment-btn" class="px-3 py-1 rounded-md retro-btn secondary">ADD</button></div></div>
                <div class="mt-6 flex justify-end gap-3"><button id="modal-cancel-btn" class="px-4 py-2 rounded-lg retro-btn secondary">CLOSE</button><button id="modal-save-btn" class="px-4 py-2 rounded-lg retro-btn">SAVE</button></div>
            `;
            showModal(content);
            renderAttachments(id, task.attachments || []);
            document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);
            document.getElementById('modal-save-btn').addEventListener('click', () => {
                const notes = document.getElementById('modal-notes').value;
                const attachments = Array.from(document.getElementById('modal-attachments-list').querySelectorAll('[data-url]')).map(a => ({ url: a.dataset.url }));
                updateTask(id, { notes, attachments });
                closeModal();
            });
            document.getElementById('add-attachment-btn').addEventListener('click', () => {
                const input = document.getElementById('new-attachment-input');
                if (input.value.trim() === '') return;
                const currentAttachments = Array.from(document.getElementById('modal-attachments-list').querySelectorAll('[data-url]')).map(a => ({ url: a.dataset.url }));
                currentAttachments.push({ url: input.value });
                renderAttachments(id, currentAttachments);
                input.value = '';
            });
        };
        
        const renderAttachments = (taskId, attachments) => {
            const container = document.getElementById('modal-attachments-list');
            container.innerHTML = '';
            attachments.forEach((att, index) => {
                const el = document.createElement('div');
                el.className = 'flex items-center gap-2 surface p-2';
                el.dataset.url = att.url;
                
                let contentHTML = `<a href="${att.url}" target="_blank" class="text-blue-400 truncate flex-grow">${att.url}</a>`;
                const youtubeId = att.url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
                if (youtubeId) {
                    contentHTML = `
                        <div class="flex-grow">
                            <iframe class="w-full aspect-video" src="https://www.youtube.com/embed/${youtubeId[1]}" frameborder="0" allowfullscreen></iframe>
                            <button class="play-bg-btn retro-btn secondary mt-2 text-xs">Play in Background</button>
                        </div>
                    `;
                }
                
                el.innerHTML = `${contentHTML} <button data-index="${index}" class="remove-attachment-btn text-red-500 text-xs retro-btn">REMOVE</button>`;
                container.appendChild(el);
            });
        };
        
        modalContainer.addEventListener('click', (e) => {
            if(e.target.closest('.remove-attachment-btn')) {
                e.target.closest('.flex').remove();
            }
            if(e.target.closest('.play-bg-btn')) {
                const url = e.target.closest('[data-url]').dataset.url;
                const youtubeId = url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
                if(youtubeId) {
                    videoBackground.innerHTML = `<iframe src="https://www.youtube.com/embed/${youtubeId[1]}?autoplay=1&controls=0&loop=1&playlist=${youtubeId[1]}" frameborder="0"></iframe>`;
                    videoBackground.classList.remove('hidden');
                    closeVideoBgBtn.classList.remove('hidden');
                    closeModal();
                }
            }
        });

        const openBulkAddModal = (parentId) => {
            const parentTask = parentId ? allTasks.find(t => t.id === parentId) : null;
            const title = parentId ? 'BULK ADD TO SUBJECT' : 'BULK ADD NEW SUBJECTS';
            const content = `
                <h3 class="text-xl font-bold mb-4">${title}</h3>
                <input type="hidden" id="bulk-add-parent-id" value="${parentId || ''}">
                <p class="text-sm text-muted mb-2">USE ONE LINE PER NEW ITEM. INDENT TO CREATE CHILDREN.</p>
                <textarea id="bulk-add-textarea" rows="8" class="mt-1 block w-full shadow-sm font-mono surface border text-muted" placeholder="Subject\n  Section\n    Chapter\n      Topic"></textarea>
                <div class="mt-6 flex justify-end gap-3"><button id="bulk-add-cancel-btn" class="px-4 py-2 retro-btn secondary">CANCEL</button><button id="bulk-add-save-btn" class="px-4 py-2 retro-btn">ADD ITEMS</button></div>
            `;
            showModal(content);
            document.getElementById('bulk-add-cancel-btn').addEventListener('click', closeModal);
            document.getElementById('bulk-add-save-btn').addEventListener('click', () => {
                const text = document.getElementById('bulk-add-textarea').value;
                const startingLevel = parentTask ? parentTask.level + 1 : 0;
                const lines = text.split('\n').filter(l => l.trim() !== '');
                const user = auth.currentUser;
                const batch = writeBatch(db);
                const tasksRef = collection(db, 'users', user.uid, 'tasks');
                let lastParentIds = { [startingLevel - 1]: parentId };
                lines.forEach(line => {
                    const indentation = line.match(/^\s*/)[0].length;
                    const level = startingLevel + Math.floor(indentation / 2);
                    const text = line.trim();
                    if (level < HIERARCHY.length) {
                        const currentParentId = lastParentIds[level - 1];
                        if (currentParentId === undefined) { console.error("Error finding parent for:", text); return; }
                        const newDocRef = doc(tasksRef);
                        batch.set(newDocRef, { text, parentId: currentParentId, level, completed: false, isFlagged: false, isCollapsed: false, notes: '', attachments: [], createdAt: serverTimestamp() });
                        lastParentIds[level] = newDocRef.id;
                    }
                });
                batch.commit();
                closeModal();
            });
        };

        // --- General Event Listeners ---
        signOutBtn.addEventListener('click', () => signOut(auth));
        themeSwitcher.addEventListener('click', (e) => {
            const themeBtn = e.target.closest('.theme-switcher-btn');
            if (themeBtn) { 
                if (e.target.isContentEditable) return;
                saveTheme(themeBtn.dataset.theme); 
            }
        });
        themeSwitcher.addEventListener('blur', (e) => {
            const themeBtn = e.target.closest('.theme-switcher-btn');
            if (themeBtn) {
                saveThemeName(themeBtn.dataset.theme, themeBtn.textContent);
            }
        }, true);
        themeSwitcher.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                e.target.blur();
            }
        });

        globalBulkAddBtn.addEventListener('click', () => openBulkAddModal(null));
        closeVideoBgBtn.addEventListener('click', () => {
            videoBackground.innerHTML = '';
            videoBackground.classList.add('hidden');
            closeVideoBgBtn.classList.add('hidden');
        });
        
    </script>
</body>
</html>
