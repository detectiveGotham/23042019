<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Productivity Hub</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .theme-transition {
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .completed-task > span {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }
        .flagged-task {
            background-color: #fef9c3 !important; /* yellow-100 */
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .modal { transition: opacity 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        
        .checkbox-icon {
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            display: inline-block;
            width: 1.25rem;
            text-align: center;
            cursor: pointer;
        }
        .collapse-icon {
            transition: transform 0.2s ease-in-out;
        }
        .collapsed .collapse-icon {
            transform: rotate(-90deg);
        }
        @keyframes flash {
            0%, 100% { color: red; }
            50% { color: inherit; }
        }
        .timer-flash {
            animation: flash 1s 3;
        }
        .calendar-day.today {
            background-color: #fef08a; /* yellow-200 */
            border-radius: 50%;
        }
    </style>
</head>
<body>

    <!-- Logged Out View -->
    <div id="logged-out-view" class="hidden h-screen flex items-center justify-center">
        <div class="text-center bg-white p-12 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold mb-4">Access Denied</h2>
            <p class="text-gray-600 mb-6">Please log in to access your productivity hub.</p>
            <a href="index.html" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">Go to Login Page</a>
        </div>
    </div>

    <!-- Main Logged In View -->
    <div id="logged-in-view" class="hidden p-4 md:p-8">
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <h1 class="text-4xl font-extrabold text-gray-800">Productivity Hub</h1>
            <div class="flex items-center gap-4 w-full md:w-auto">
                 <div class="relative w-full md:w-64">
                    <input type="text" id="search-input" placeholder="Search tasks..." class="w-full pl-10 pr-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <button id="sign-out-btn" class="text-sm font-medium text-gray-600 hover:text-indigo-600 theme-transition flex-shrink-0">Sign Out <i class="fas fa-sign-out-alt ml-1"></i></button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Main Content: Checklist -->
            <div class="lg:col-span-2 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-md theme-transition">
                    <div class="flex justify-between items-center mb-4">
                         <h2 class="text-xl font-bold">My Master Checklist</h2>
                         <span id="progress-text" class="text-sm font-semibold text-gray-600">0% Complete</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-4">
                        <div id="progress-bar" class="bg-green-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div id="task-list-container" class="space-y-2 max-h-[60vh] overflow-y-auto no-scrollbar">
                        <p id="loading-placeholder" class="text-gray-500">Loading your tasks...</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md theme-transition">
                    <h2 class="text-xl font-bold mb-4">Add New Subject</h2>
                    <form id="add-subject-form">
                        <textarea id="subject-input" class="w-full p-3 border border-gray-300 rounded-lg" rows="1" placeholder="Enter a new subject..."></textarea>
                        <button type="submit" class="mt-3 w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700">Add Subject</button>
                    </form>
                </div>
            </div>

            <!-- Sidebar: Widgets -->
            <div class="space-y-6">
                <!-- Timer Card -->
                <div class="bg-white p-6 rounded-xl shadow-md theme-transition">
                    <h2 class="text-xl font-bold mb-4">Focus Mode</h2>
                    <div class="text-center"><p id="timer-display" class="text-5xl font-mono font-bold text-gray-800">00:00</p></div>
                    <div class="flex items-center gap-2 mt-4"><input type="number" id="minutes-input" placeholder="Mins" min="0" class="w-full p-2 border rounded-lg text-center"><button id="set-time-btn" class="px-4 py-2 bg-gray-200 rounded-lg">Set</button></div>
                    <div class="flex justify-center gap-2 mt-4"><button id="start-pause-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg w-24">Start</button><button id="reset-btn" class="px-4 py-2 bg-gray-500 text-white rounded-lg">Reset</button></div>
                </div>
                <!-- Calendar -->
                <div class="bg-white p-6 rounded-xl shadow-md theme-transition">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-left"></i></button>
                        <h2 id="calendar-header" class="text-xl font-bold"></h2>
                        <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center text-sm"></div>
                </div>
                <!-- Theme Selector -->
                <div class="bg-white p-6 rounded-xl shadow-md theme-transition">
                    <h2 class="text-xl font-bold mb-4">Select Theme</h2>
                    <div class="grid grid-cols-2 gap-4"><button class="p-4 border-2 border-indigo-500 rounded-lg">Classic</button><button class="p-4 border rounded-lg bg-gray-800 text-white">Batman</button><button class="p-4 border rounded-lg">Iron Man</button><button class="p-4 border rounded-lg">Wonder Woman</button></div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modals -->
    <div id="notes-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg p-6 transform -translate-y-10">
            <h3 class="text-xl font-bold mb-4">Edit Details</h3>
            <input type="hidden" id="modal-task-id">
            <div><label for="modal-notes" class="block text-sm font-medium text-gray-700">Notes</label><textarea id="modal-notes" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"></textarea></div>
            <div class="mt-4"><label for="modal-attachments" class="block text-sm font-medium text-gray-700">Attachments (Links)</label><div id="modal-attachments-list" class="space-y-2 mt-2"></div><div class="flex gap-2 mt-2"><input type="url" id="new-attachment-input" placeholder="https://example.com" class="flex-grow rounded-md border-gray-300 shadow-sm"><button id="add-attachment-btn" class="px-3 py-1 bg-gray-200 rounded-md">Add</button></div></div>
            <div class="mt-6 flex justify-end gap-3"><button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-lg">Cancel</button><button id="modal-save-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Save</button></div>
        </div>
    </div>
    <div id="bulk-add-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg p-6 transform -translate-y-10">
            <h3 class="text-xl font-bold mb-4">Bulk Add to Subject</h3>
            <input type="hidden" id="bulk-add-parent-id">
            <p class="text-sm text-gray-600 mb-2">Use indentation (2 spaces) for hierarchy.</p>
            <textarea id="bulk-add-textarea" rows="8" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm font-mono" placeholder="Section Name&#10;  Chapter Name&#10;    Topic Name&#10;Another Section"></textarea>
            <div class="mt-6 flex justify-end gap-3"><button id="bulk-add-cancel-btn" class="px-4 py-2 bg-gray-200 rounded-lg">Cancel</button><button id="bulk-add-save-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">Add Items</button></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCKcC_TPxyP9-ErqUTZHWc4Il8llwpwUg8",
            authDomain: "forge23-04-2019.firebaseapp.com",
            projectId: "forge23-04-2019",
            storageBucket: "forge23-04-2019.appspot.com",
            messagingSenderId: "725283917440",
            appId: "1:725283917440:web:3627779e1de23153af2065",
            measurementId: "G-FHF15XRWC3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- UI & State Variables ---
        const loggedInView = document.getElementById('logged-in-view');
        const loggedOutView = document.getElementById('logged-out-view');
        const signOutBtn = document.getElementById('sign-out-btn');
        const searchInput = document.getElementById('search-input');
        const addSubjectForm = document.getElementById('add-subject-form');
        const subjectInput = document.getElementById('subject-input');
        const taskListContainer = document.getElementById('task-list-container');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        
        // Calendar Elements
        const calendarGrid = document.getElementById('calendar-grid');
        const calendarHeader = document.getElementById('calendar-header');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        
        // Timer Elements
        const timerDisplay = document.getElementById('timer-display');
        const minutesInput = document.getElementById('minutes-input');
        const setTimeBtn = document.getElementById('set-time-btn');
        const startPauseBtn = document.getElementById('start-pause-btn');
        const resetBtn = document.getElementById('reset-btn');
        
        // Modals
        const notesModal = document.getElementById('notes-modal');
        const modalTaskId = document.getElementById('modal-task-id');
        const modalNotes = document.getElementById('modal-notes');
        const modalAttachmentsList = document.getElementById('modal-attachments-list');
        const newAttachmentInput = document.getElementById('new-attachment-input');
        const addAttachmentBtn = document.getElementById('add-attachment-btn');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const bulkAddModal = document.getElementById('bulk-add-modal');
        const bulkAddParentId = document.getElementById('bulk-add-parent-id');
        const bulkAddTextarea = document.getElementById('bulk-add-textarea');
        const bulkAddSaveBtn = document.getElementById('bulk-add-save-btn');
        const bulkAddCancelBtn = document.getElementById('bulk-add-cancel-btn');


        let tasksUnsubscribe = null;
        let allTasks = [];
        const HIERARCHY = ['Subject', 'Section', 'Chapter', 'Topic'];
        let currentCalendarDate = new Date();

        let timerInterval = null;
        let timerSeconds = 0;
        let isTimerRunning = false;
        
        // --- Auth State ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loggedInView.classList.remove('hidden');
                loggedOutView.classList.add('hidden');
                getTasks(user.uid);
            } else {
                loggedInView.classList.add('hidden');
                loggedOutView.classList.remove('hidden');
                if (tasksUnsubscribe) tasksUnsubscribe();
                clearInterval(timerInterval);
            }
        });

        // --- Data Handling & Rendering ---
        const getTasks = (userId) => {
            const q = query(collection(db, 'users', userId, 'tasks'));
            tasksUnsubscribe = onSnapshot(q, (snapshot) => {
                allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTaskTree(buildTree(allTasks));
                updateMasterProgressBar();
                renderCalendar();
            });
        };

        const buildTree = (tasks, parentId = null) => {
            return tasks
                .filter(task => task.parentId === parentId)
                .map(task => ({ ...task, children: buildTree(tasks, task.id) }));
        };

        const renderTaskTree = (taskTree) => {
            taskListContainer.innerHTML = '';
            if (taskTree.length === 0) {
                taskListContainer.innerHTML = '<p class="text-gray-500">No subjects yet. Add one below!</p>';
                return;
            }
            taskTree.forEach(taskNode => renderTask(taskNode, 0));
        };

        const renderTask = (taskNode, level) => {
            const taskEl = document.createElement('div');
            taskEl.setAttribute('data-id', taskNode.id);
            taskEl.className = `task-item-container border-l-2 border-transparent ${taskNode.isCollapsed ? 'collapsed' : ''}`;
            
            const hasChildren = taskNode.children && taskNode.children.length > 0;
            const isMaxDepth = level >= HIERARCHY.length - 1;

            const checkboxIcons = [
                { unchecked: 'fa-regular fa-square', checked: 'fa-solid fa-square-check text-green-500' },
                { unchecked: 'fa-regular fa-circle', checked: 'fa-solid fa-circle-check text-green-500' },
                { unchecked: 'fa-solid fa-diamond', checked: 'fa-solid fa-check-to-slot text-green-500' },
                { unchecked: 'fa-regular fa-square', checked: 'fa-solid fa-square-check text-green-500' }
            ];
            const iconSet = checkboxIcons[level];
            const checkboxIconClass = taskNode.completed ? iconSet.checked : iconSet.unchecked;
            
            let subjectProgressBarHTML = '';
            if (level === 0) {
                const descendantIds = getDescendantIds(taskNode.id, allTasks);
                const relevantTasks = allTasks.filter(t => descendantIds.includes(t.id));
                const completedCount = relevantTasks.filter(t => t.completed).length;
                const subjectProgress = relevantTasks.length > 0 ? (completedCount / relevantTasks.length) * 100 : 0;
                subjectProgressBarHTML = `
                    <div class="w-full bg-gray-200 rounded-full h-1.5 mt-2">
                        <div class="bg-blue-500 h-1.5 rounded-full" style="width: ${subjectProgress}%"></div>
                    </div>`;
            }

            taskEl.innerHTML = `
                <div class="task-item group p-2 rounded-lg flex items-center gap-2 ${taskNode.isFlagged ? 'flagged-task' : 'bg-gray-50'}">
                    <i class="collapse-icon fa-solid fa-chevron-down w-4 text-center text-gray-400 ${hasChildren ? '' : 'invisible'}"></i>
                    <i class="checkbox-icon ${checkboxIconClass} text-indigo-600"></i>
                    <span class="flex-grow font-medium text-gray-800 ${taskNode.completed ? 'completed-task' : ''}" contenteditable="true" spellcheck="false">${taskNode.text}</span>
                    <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button title="Bulk Add" class="bulk-add-btn text-gray-400 hover:text-purple-500 ${level === 0 ? '' : 'hidden'}"><i class="fa-solid fa-file-import"></i></button>
                        <button title="Add ${isMaxDepth ? '' : HIERARCHY[level+1]}" class="add-subtask-btn text-gray-400 hover:text-green-500 ${isMaxDepth ? 'hidden' : ''}"><i class="fas fa-plus-circle"></i></button>
                        <button title="Flag" class="flag-btn text-gray-400 hover:text-yellow-500 ${taskNode.isFlagged ? 'text-yellow-500' : ''}"><i class="fas fa-flag"></i></button>
                        <button title="Notes" class="notes-btn text-gray-400 hover:text-blue-500"><i class="far fa-sticky-note"></i></button>
                        <button title="Delete" class="delete-btn text-gray-400 hover:text-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                ${subjectProgressBarHTML}
                <div class="children-container pl-6 border-l-2 border-gray-200 ml-3"></div>
            `;
            taskListContainer.appendChild(taskEl);

            const span = taskEl.querySelector('span');
            span.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); span.blur(); } });
            span.addEventListener('blur', () => updateTaskText(taskNode.id, span.textContent));
            taskEl.querySelector('.collapse-icon').addEventListener('click', () => toggleCollapse(taskNode.id, !taskNode.isCollapsed));
            taskEl.querySelector('.checkbox-icon').addEventListener('click', () => toggleTaskCompleteWithChildren(taskNode.id, !taskNode.completed));
            taskEl.querySelector('.add-subtask-btn').addEventListener('click', () => addTask(HIERARCHY[level + 1], taskNode.id, level + 1));
            taskEl.querySelector('.bulk-add-btn')?.addEventListener('click', () => openBulkAddModal(taskNode.id));
            taskEl.querySelector('.flag-btn').addEventListener('click', () => toggleFlag(taskNode.id, !taskNode.isFlagged));
            taskEl.querySelector('.notes-btn').addEventListener('click', () => openNotesModal(taskNode.id));
            taskEl.querySelector('.delete-btn').addEventListener('click', () => deleteTaskWithChildren(taskNode.id));

            if (hasChildren && !taskNode.isCollapsed) {
                const childrenContainer = taskEl.querySelector('.children-container');
                taskNode.children.forEach(childNode => {
                    const childEl = renderTask(childNode, level + 1);
                    childrenContainer.appendChild(childEl);
                });
            }
            return taskEl;
        };
        
        const updateMasterProgressBar = () => {
            const subjects = allTasks.filter(t => t.parentId === null);
            if (subjects.length === 0) {
                progressBar.style.width = '0%';
                progressText.textContent = '0% Complete';
                return;
            }
            const completedSubjects = subjects.filter(s => {
                const descendantIds = getDescendantIds(s.id, allTasks);
                if (descendantIds.length === 0) return s.completed;
                const descendants = allTasks.filter(t => descendantIds.includes(t.id));
                return descendants.length > 0 && descendants.every(d => d.completed);
            }).length;
            const percentage = Math.round((completedSubjects / subjects.length) * 100);
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `${percentage}% Complete`;
        };
        
        const getDescendantIds = (parentId, tasks) => {
            let descendants = [];
            const children = tasks.filter(task => task.parentId === parentId);
            children.forEach(child => {
                descendants.push(child.id);
                descendants = descendants.concat(getDescendantIds(child.id, tasks));
            });
            return descendants;
        };

        // --- Firestore Actions ---
        const addTask = (text, parentId = null, level = 0) => {
            const user = auth.currentUser;
            if (!user) return;
            addDoc(collection(db, 'users', user.uid, 'tasks'), {
                text, parentId, level, completed: false, isFlagged: false, isCollapsed: false, notes: '', attachments: [], createdAt: serverTimestamp()
            });
        };

        addSubjectForm.addEventListener('submit', e => {
            e.preventDefault();
            if (subjectInput.value.trim() === '') return;
            addTask(subjectInput.value, null, 0);
            subjectInput.value = '';
        });
        
        const updateTaskText = (id, text) => updateDoc(doc(db, 'users', auth.currentUser.uid, 'tasks', id), { text });
        const toggleFlag = (id, isFlagged) => updateDoc(doc(db, 'users', auth.currentUser.uid, 'tasks', id), { isFlagged });
        const toggleCollapse = (id, isCollapsed) => updateDoc(doc(db, 'users', auth.currentUser.uid, 'tasks', id), { isCollapsed });
        
        const toggleTaskCompleteWithChildren = (taskId, isCompleted) => {
            const user = auth.currentUser;
            if (!user) return;
            const batch = writeBatch(db);
            const taskMap = new Map(allTasks.map(task => [task.id, task]));
            const idsToUpdate = [taskId, ...getDescendantIds(taskId, allTasks)];
            idsToUpdate.forEach(id => {
                batch.update(doc(db, 'users', user.uid, 'tasks', id), { completed: isCompleted, completedAt: isCompleted ? serverTimestamp() : null });
            });
            let currentTask = taskMap.get(taskId);
            let parentId = currentTask ? currentTask.parentId : null;
            while (parentId) {
                const parent = taskMap.get(parentId);
                const siblings = allTasks.filter(t => t.parentId === parentId);
                const allSiblingsComplete = siblings.every(s => idsToUpdate.includes(s.id) ? isCompleted : s.completed);
                batch.update(doc(db, 'users', user.uid, 'tasks', parentId), { completed: allSiblingsComplete });
                parentId = parent.parentId;
            }
            batch.commit();
        };

        const deleteTaskWithChildren = (taskId) => {
            const user = auth.currentUser;
            if (!user) return;
            const idsToDelete = [taskId, ...getDescendantIds(taskId, allTasks)];
            const batch = writeBatch(db);
            idsToDelete.forEach(id => batch.delete(doc(db, 'users', user.uid, 'tasks', id)));
            batch.commit();
        };

        // --- Search Logic ---
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.trim().toLowerCase();
            const taskMap = new Map(allTasks.map(task => [task.id, task]));
            if (!searchTerm) {
                renderTaskTree(buildTree(allTasks));
                return;
            }
            const matchingIds = new Set();
            allTasks.forEach(task => {
                if (task.text.toLowerCase().includes(searchTerm)) {
                    let current = task;
                    while (current) {
                        matchingIds.add(current.id);
                        current = current.parentId ? taskMap.get(current.parentId) : null;
                    }
                }
            });
            const filteredTasks = allTasks.filter(task => matchingIds.has(task.id));
            renderTaskTree(buildTree(filteredTasks));
        });

        // --- Timer Logic ---
        const updateTimerDisplay = () => {
            const minutes = Math.floor(timerSeconds / 60).toString().padStart(2, '0');
            const seconds = (timerSeconds % 60).toString().padStart(2, '0');
            timerDisplay.textContent = `${minutes}:${seconds}`;
        };
        const startPauseTimer = () => {
            if (timerSeconds <= 0 && !isTimerRunning) return;
            if (isTimerRunning) {
                clearInterval(timerInterval);
                isTimerRunning = false;
                startPauseBtn.textContent = 'Resume';
                startPauseBtn.classList.replace('bg-yellow-500', 'bg-green-500');
            } else {
                isTimerRunning = true;
                startPauseBtn.textContent = 'Pause';
                startPauseBtn.classList.replace('bg-green-500', 'bg-yellow-500');
                timerInterval = setInterval(() => {
                    timerSeconds--;
                    updateTimerDisplay();
                    if (timerSeconds <= 0) {
                        clearInterval(timerInterval);
                        timerDisplay.classList.add('timer-flash');
                        setTimeout(() => timerDisplay.classList.remove('timer-flash'), 3000);
                        resetTimer();
                    }
                }, 1000);
            }
        };
        const resetTimer = () => {
            clearInterval(timerInterval);
            isTimerRunning = false;
            timerSeconds = 0;
            minutesInput.value = '';
            updateTimerDisplay();
            startPauseBtn.textContent = 'Start';
            startPauseBtn.classList.replace('bg-yellow-500', 'bg-green-500');
        };
        setTimeBtn.addEventListener('click', () => {
            const mins = parseInt(minutesInput.value);
            if (!isNaN(mins) && mins > 0) {
                resetTimer();
                timerSeconds = mins * 60;
                updateTimerDisplay();
            }
        });
        startPauseBtn.addEventListener('click', startPauseTimer);
        resetBtn.addEventListener('click', resetTimer);

        // --- Calendar Logic ---
        const renderCalendar = () => {
            calendarGrid.innerHTML = '';
            const month = currentCalendarDate.getMonth();
            const year = currentCalendarDate.getFullYear();
            calendarHeader.textContent = `${currentCalendarDate.toLocaleString('default', { month: 'long' })} ${year}`;

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const completionsByDate = {};
            allTasks.forEach(task => {
                if (task.completed && task.completedAt) {
                    const dateStr = task.completedAt.toDate().toISOString().split('T')[0];
                    completionsByDate[dateStr] = (completionsByDate[dateStr] || 0) + 1;
                }
            });

            const dayHeaders = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            dayHeaders.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'font-bold text-gray-500';
                dayEl.textContent = day;
                calendarGrid.appendChild(dayEl);
            });

            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarGrid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.textContent = day;
                dayEl.className = 'p-1 rounded-md calendar-day';
                
                const dateStr = new Date(year, month, day).toISOString().split('T')[0];
                const todayStr = new Date().toISOString().split('T')[0];
                if(dateStr === todayStr) {
                    dayEl.classList.add('today');
                }

                const count = completionsByDate[dateStr] || 0;
                let level = 0;
                if (count > 0) level = 1; if (count > 2) level = 2; if (count > 5) level = 3; if (count > 8) level = 4;
                if (level > 0) {
                    dayEl.style.backgroundColor = `rgba(34, 197, 94, ${level * 0.25})`;
                }
                dayEl.title = `${count} tasks on ${new Date(year, month, day).toDateString()}`;
                calendarGrid.appendChild(dayEl);
            }
        };
        prevMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        });
        nextMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        });

        // --- Modal Logic ---
        const openNotesModal = (id) => {
            const task = allTasks.find(t => t.id === id);
            if (!task) return;
            modalTaskId.value = id;
            modalNotes.value = task.notes || '';
            renderAttachments(task.attachments || []);
            notesModal.classList.remove('hidden');
        };
        const openBulkAddModal = (parentId) => {
            bulkAddParentId.value = parentId;
            bulkAddTextarea.value = '';
            bulkAddModal.classList.remove('hidden');
        };
        const closeNotesModal = () => notesModal.classList.add('hidden');
        const closeBulkAddModal = () => bulkAddModal.classList.add('hidden');

        const renderAttachments = (attachments) => {
            modalAttachmentsList.innerHTML = '';
            attachments.forEach((att) => {
                const el = document.createElement('div');
                el.className = 'flex items-center gap-2 bg-gray-100 p-1 rounded';
                el.innerHTML = `<a href="${att.url}" target="_blank" class="text-blue-600 truncate flex-grow">${att.url}</a> <button class="remove-attachment-btn text-red-500 text-xs">Remove</button>`;
                modalAttachmentsList.appendChild(el);
            });
        };
        addAttachmentBtn.addEventListener('click', () => {
            if (newAttachmentInput.value.trim() === '') return;
            const currentAttachments = Array.from(modalAttachmentsList.querySelectorAll('a')).map(a => ({ url: a.href }));
            currentAttachments.push({ url: newAttachmentInput.value });
            renderAttachments(currentAttachments);
            newAttachmentInput.value = '';
        });
        modalAttachmentsList.addEventListener('click', (e) => {
            if (e.target.closest('.remove-attachment-btn')) {
                e.target.closest('.flex').remove();
            }
        });
        modalSaveBtn.addEventListener('click', () => {
            const id = modalTaskId.value;
            const notes = modalNotes.value;
            const attachments = Array.from(modalAttachmentsList.querySelectorAll('a')).map(a => ({ url: a.href }));
            updateDoc(doc(db, 'users', auth.currentUser.uid, 'tasks', id), { notes, attachments });
            closeNotesModal();
        });
        bulkAddSaveBtn.addEventListener('click', () => {
            const parentId = bulkAddParentId.value;
            const text = bulkAddTextarea.value;
            const parentTask = allTasks.find(t => t.id === parentId);
            if (!parentTask) return;
            
            const lines = text.split('\n').filter(l => l.trim() !== '');
            const user = auth.currentUser;
            const batch = writeBatch(db);
            const tasksRef = collection(db, 'users', user.uid, 'tasks');
            
            let lastParentIds = { [parentTask.level]: parentId };

            lines.forEach(line => {
                const indentation = line.match(/^\s*/)[0].length;
                const level = parentTask.level + 1 + Math.floor(indentation / 2); // 2 spaces per indent
                const text = line.trim();

                if (level < HIERARCHY.length) {
                    const currentParentId = lastParentIds[level - 1];
                    if (!currentParentId) { console.error("Error finding parent for:", text); return; }
                    const newDocRef = doc(tasksRef);
                    batch.set(newDocRef, {
                        text, parentId: currentParentId, level, completed: false, isFlagged: false, isCollapsed: false, notes: '', attachments: [], createdAt: serverTimestamp()
                    });
                    lastParentIds[level] = newDocRef.id;
                }
            });
            batch.commit();
            closeBulkAddModal();
        });

        modalCancelBtn.addEventListener('click', closeNotesModal);
        bulkAddCancelBtn.addEventListener('click', closeBulkAddModal);

        // --- General Event Listeners ---
        signOutBtn.addEventListener('click', () => signOut(auth));

    </script>
</body>
</html>
